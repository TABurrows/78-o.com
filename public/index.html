<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Reference Implementation of a REST API for publishing bitcoin / GBP pricing data">
    <title>Reference Implementation of a REST API for Bitcoin / GBP pricing data</title>
    <link href="//fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet" type="text/css">
    <link href="./css/style.css" rel="stylesheet" type="text/css">
  </head>
  <body>
    <!-- &#42; = asterisk -->
    <!-- &#63; = question mark -->
  <div class="explainTab"><div id="tabText"><span id="showExplanations">Show</span><br/>Annotations</div><span id="tabSymbol">&#63;</span></div>
  <div class="view">
    <!-- annotation -->
    <div class="explain">
    <div class="pointUpLeft"></div>
    <div class="bubble">
    The domain is resolved to an IP address at the ISP's DNS server in Amsterdam<br/><br/>
    The website and API are published from a cloud VM instance located in Ireland.
    </div>
    <div class="pointDownCentre"></div>
    </div>
    <!-- annotation -->
  <header>
  <h1>78-o.com</h1>
  <h2>Reference Implementation of a REST API for publishing bitcoin / GBP pricing data</h2>
    <!-- annotation -->
  	<div class="explain">
  	<div class="bubble">
  	A canvas element is used to draw the graph's price data using the chart.js javascript library.
  	</div>
  	<div class="pointDownCentre"></div>
  	</div>
  	<!-- annotation -->
  <span id="stampdate"></span>
	<div id="chart"><canvas id="priceChart" width="360" height="360"></canvas></div>
  </header>
  <table class="status">
    <thead>
      <tr>
        <th>Last Price</th>
        <th>Total Volume</th>
        <th>24 hr Average</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td id="stamptime"></td>
        <td id="total_vol"></td>
        <td id="p24h_avg"></td>
      </tr>
      <tr>
          <td colspan=3><div id="stampdate"></div></td>
      </tr>
    </tbody>
  </table>



  <section>
  <p>The bitcoin / GBP price data is updated every 15 mintues and, originally sourced from the freely available <strong>bitcoin average v1 API</strong>, the api data is served from a local database.</p>
  <h3>Data Symbols</h3>
  <table class="dictionary">
    <tbody>
      <tr><td><strong>ask</strong></td><td>This value represents the offered selling price of a single bitcoin in GBP at the given <strong>timestamp</strong>.</td></tr>
      <tr><td><strong>bid</strong></td><td>This value represents the offered buying price of a single bitcoin in GBP at the given <strong>timestamp</strong>.</td></tr>
      <tr><td><strong>total_vol</strong></td><td>This value represents the total number of bitcoins traded at the given <strong>timestamp</strong>.</td></tr>
      <tr><td><strong>last</strong></td><td>The value of the price of the most recent trade at the given <strong>timestamp</strong>. It can be an indicator as to the direction prices might take in the near future.</td</tr>
      <tr><td><strong>p24h_avg</strong></td><td>The 24 Hour Average price value at the given <strong>timestamp</strong>. It can indicate how current prices are moving in comparison to trades completed over the last day.</td></tr>
      <tr><td><strong>timestamp</strong></td><td>The UTC Date and 24 Hour time of the result's values.</td></tr>
    </tbody>
  </table>
  </section>

  <section>
    <h3>Example API Usage</h3>
    <!-- annotation -->
    <div class="explain">
    <div class="bubble">
    API data is collected from the database with parameterized SQL queries and server from a LEMP stack.
    </div>
    <div class="pointDownCentre"></div>
    </div>
    <!-- annotation -->
  <p>The default request form returns the ten most recent recorded bitcoin / GBP prices in JSON object format:</p>
  <code class="request"><a>https://78-o.com/api/price/bitcoin</a></code>
    <!-- annotation -->
    <div class="explain">
    <div class="pointUpLeft"></div>
    <div class="bubble">
    The build script can publish in one step but is configured to fail if tests against the assertions made in the code's logic also fail.
    </div>
    </div>
    <!-- annotation -->
  <p>To return more than the default first ten results, supply a <strong>limit</strong> query parameter value to a maximum of 100:</p>
  <code class="request"><a>https://78-o.com/api/price/bitcoin/?startDate=2016-7-22&limit=3</a></code>
    <!-- annotation -->
    <div class="explain">
    <div class="pointUpLeft"></div>
    <div class="bubble">
    Built-in PHP flags and filters are used to validate and sanitize user input and escape user-bound output.
    </div>
    </div>
    <!-- annotation -->
  <p>Use the <strong>startHour</strong> query parameter along with <strong>startDate</strong> and <strong>limit</strong> to return results for a specific time frame:</p>
    <code class="request"><a>https://78-o.com/api/price/bitcoin/?startDate=2016-07-20&startHour=13&limit=2</a></code>
  <p>Requests can be made over the <strong>HTTPS</strong> endpoint if the client trusts the <a href="letsencrypt.org">letsencrypt.org</a> CA Certificates:</p>
    <code class="request"><a>https://78-o.com/api/price/bitcoin/?limit=2</a></code>
    	<!-- annotation -->
    	<div class="explain">
    	<div class="bubble">
    	Pure JS and the JQuery javascript library is used to reference page elements and build additional functionality.
    	</div>
    	<div class="pointDownCentre"></div>
    	</div>
    	<!-- annotation -->
  <p>To make requests across domains <strong>JSONP</strong> is supported:</p>
    <code class="request"><a>https://78-o.com/api/price/bitcoin/?limit=1&callback=?</a></code>
  <p>Example API use with <a href="https://jquery.com" target="_blank">jquery</a> javascript library:</p>
    <code class="js">(function() {
$.getJSON( "https://78-o.com/api/price/bitcoin/?limit=1&callback=?")
  .done(function( results ) {
  $.each(results, function(index, result) {
    $("#resultsDiv").append("Ask value: " + result['ask'] + "&lt;br /&gt;");
    $("#resultsDiv").append("Bid value: " + result['bid'] + "&lt;br /&gt;");
    $("#resultsDiv").append("Timestamp: " + result['timestamp'] + "&lt;br /&gt;");
    if(index === 'Result1') return false;
  });
});
})();
    </code>
	</section>
	<section>
  <ol>
  	<li>TLS is provided by <a href="//letsencrypt.org" target="_blank">letsencrypt.org</a> asymmetric encryption.</li>
  	<li>The site is served from a <a href="//nginx.org" target="_blank">nginx community edition</a> web server.</li>
  	<li>Hosted on an <a href="//azure.microsoft.com" target="_blank">Azure Cloud Services</a> A0 virtual machine.</li>
  	<li>Bitcoin price data is originally sourced from <a href="//bitcoinaverage.com/" target="_blank">Bitcoin Average</a> v1 API.</li>
    <li>Developed with <a href="//atom.io">atom</a>, <a href="//developer.mozilla.org/en-US/Firefox/Developer_Edition">Firefox</a> and <a href="//www.gnu.org/software/bash/">bash</a>.</li>
  	<li>The source is available on <a href="//github.com/taburrows/78-o.com">GitHub</a>.</li>
  </ol>
  </section>
    <!-- annotation -->
    <div class="explain">
    <div class="bubble">
    HTML5 semantic elements 'footer' are used to logically describe the document's layout which should help screen readers, search engines, robots etc.
    </div>
    <div class="pointDownCentre"></div>
    </div>
    <!-- annotation -->
  <footer>
  This website and it's API is published only as an exercise in web programming and development.  It should not be relied upon for timely, accurate or correct price information.  It should not be used for any kind of financial decision making, trading or investing. It has <strong>no warranty</strong> of any kind.
  </footer>
    <!-- annotation -->
    <div class="explain">
    <div class="bubble">
    Additional required libraries are sourced from CDNs if not present in the browser's cache.<br /><br />
    Fetching these javascript files is deferred until the rest of the page content has downloaded.
    </div>
    <div class="pointDownLeft"></div>
    </div>
    <!-- annotation -->
    <!-- annotation -->
    <div class="explain">
    <div class="bubble">
    JS code written to enable functionality is unbundled / unminified and formatted for human readability at the end of the page's source.
    </div>
    <div class="pointDownLeft"></div>
    </div>
    <!-- annotation -->
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/Chart.js/2.1.6/Chart.min.js"></script>
<script>
"use strict";
//----------------------------------------
var priceChartConfig = {
type: 'line',
data: {
labels: ["00:00:00", "00:00:00", "00:00:00", "00:00:00", "00:00:00", "00:00:00", "00:00:00", "00:00:00", "00:00:00", "00:00:00"],
  datasets: [{
  label: "24h avg",
  borderColor: 'rgba(80, 80, 80, 0.7)',
  backgroundColor: 'rgb(255, 255, 255)',
  pointBorderColor: 'rgba(80, 80, 80, 0.7)',
  pointBackgroundColor: 'rgb(255, 255, 255)',
  pointBorderWidth: 2,
  data: [497, 497, 497, 497, 497, 497, 497, 497, 497, 497],
  fill: false,
  borderDash: [4, 6]
}, {
  label: 'last',
  borderColor: 'rgba(252,234,34,0.7)',
  backgroundColor: 'rgb(255,255,255)',
  pointBorderColor: 'rgba(252,234,34,0.7)',
  pointBackgroundColor: 'rgb(255,255,255)',
  pointBorderWidth: 2,
  data: [495, 495, 495, 495, 495, 495, 495, 495, 495, 495],
  fill: false,
  borderDash: [4, 6]
}, {
  label: 'ask',
  borderColor: 'rgba(169, 253, 106, 0.7)',
  backgroundColor: 'rgba(169, 253, 106, 0.4)',
  pointBorderColor: 'rgba(182, 209, 113, 0.7)',
  pointBackgroundColor: 'rgba(169, 253, 106, 0.4)',
  pointBorderWidth: 1,
  data: [500, 500, 500, 500, 500, 500, 500, 500, 500, 500],
  fill: true
}, {
  label: 'bid',
  borderColor: 'rgba(182, 209, 113, 0.7)',
  backgroundColor: 'rgba(182, 209, 113, 0.4)',
  pointBorderColor: 'rgba(182, 209, 113, 0.7)',
  pointBackgroundColor: 'rgba(182, 209, 113, 0.4)',
  pointBorderWidth: 1,
  data: [490, 490, 490, 490, 490, 490, 490, 490, 490, 490],
  fill: true
}]
},
options: {
  responsive: true,
  responsiveAnimationDuration: 100,
title:{
  display:true,
  text:'Bitcoin / GBP Price Chart'
},
tooltips: {
  mode: 'label',
  titleFontSize: 14,
  backgroundColor: 'rgba(132, 159, 83, 0.9)',
callbacks: {
  }
},
hover: {
  mode: 'dataset'
},
scales: {
  xAxes: [{
    display: true,
    scaleLabel: {
      display: true,
      labelString: 'Time (UTC)'
    }
  }],
  yAxes: [{
    display: true,
    scaleLabel: {
      display: true,
      labelString: 'Price (GBP)'
    }
  }]
  }
}};
//----------------------------------------
var getChartData = function() {
	var data =$.getJSON( "/api/price/bitcoin/", function(results) {
		var ts = results.results[0].timestamp;
		var td = ts.substr(0,ts.length-14);
		var tm = ts.substr(ts.length-14).substr(0,9);
		$('#stampdate').text(td);
		$('#stamptime').text(tm + " UTC");
		$('#total_vol').text(results.results[0].total_vol);
		$('#p24h_avg').text(results.results[0].p24h_avg);
		var ask = [];
		var bid = [];
		var avg = [];
		var lst = [];
		var lbls = [];
		$.each(results.results, function(i, result) {
	        $.each(result, function(k,v) {
				if('ask' == k)
					ask.push(v);
				if('bid' == k)
					bid.push(v);
				if('p24h_avg' == k)
					avg.push(v);
				if('last' == k)
					lst.push(v);
				if('timestamp' == k) 
					lbls.push(v.substr(v.length-14).substr(0,5));
			});
		});
		var dsets = [ avg.reverse(), lst.reverse(), ask.reverse(), bid.reverse() ];
		priceChartConfig.data.labels = lbls.reverse();
	        $.each(priceChartConfig.data.datasets, function(i, dataset) {
	                dataset.data = dsets[i]
		});
		window.priceChartCanvas.update();
  	console.log( "Successfully received data from XHR request." );
	  })
	  .fail(function(e) {
	    console.log( "There was an error connecting to the bitcoin price api: " + e.message);
	  })
	  .always(function() {
	  });
};
//----------------------------------------
window.onload = function() {
  // Set the chart context and configuration
  var priceChartContext = document.getElementById("priceChart").getContext("2d");
  window.priceChartCanvas = new Chart(priceChartContext, priceChartConfig);
  getChartData();
  // Make API examples clickable
  $('code.request').each(function() {
    var $this = $(this);
    //get the real location from the browser
    var urn =  window.location.protocol + "//" + window.location.host + '/';
    //use jQuery to find the <a> tags
    var url = $this.html().match(/<a>([^<]+)/)[1];
    //remove the printed location line and replace with real
    url = url.replace('https://78-o.com/', urn);
    //replace html ampersands with url versions
    url = url.replace(/&amp;/g, '&');
    //add event handlers that will fetch the newly built url from the api
    $this.on('click', function(e) {
      var $pre = $this.find('pre');
      if ($pre.length) {
        $pre.remove();
      } else {
        $.getJSON(url, function(data) {
          $this.append('<pre>' + JSON.stringify(data, undefined, 4) + '</pre>');
        });
      }
    });
  });
  //say hello
  console.log("Hello!");
  console.log("I'm often here as well ... :-)");
};
//----------------------------------------
$('.explainTab').mouseover(function() {
	$(this).addClass('showExplainTab');
});
$('.explainTab').mouseout(function() {
	$(this).removeClass('showExplainTab');
});
$('.explainTab').mouseup(function(){
  setTimeout(function() { $(this).removeClass('showExplainTab'); }, 3000);
});
$('.explainTab').click(function() {
	$('.explain').each(function(){
		if ($(this).hasClass('hatch')) {
			$(this).removeClass('hatch');
			$('#showExplanations').text('Show');
		} else {
			$(this).addClass('hatch');
			$('#showExplanations').text('Hide');
		} });
});
//----------------------------------------
</script>
</body>
</html>
